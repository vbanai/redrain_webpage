<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Red Rain - Chats </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.0/css/line.css" />

 
    <link rel="stylesheet" href="/static/chattable.css">

  
    
  </head>
    

<body>
  <div class="header" style="position: relative; display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 1rem;">
  
    <!-- Logo -->
    <div style="flex: 0 0 auto;">
      <img src="static/RedRainLogo8.png" alt="Logo" style="height: 50px;">
    </div>

    <!-- Centered topic text -->
    <div id="navItem2" style="position: absolute; left: 50%; transform: translateX(-50%); text-align: center; display: flex; align-items: center; gap: 1.5rem;">
      <a href="#chattopic" class="buttonsubscription" id="buttonSubscription" style="color:white; font-size:clamp(12px, 1.5vw, 18px); margin:0;" data-lang="chattopic">Chat Témakörök</a>
      <div class="dropdown">
        <div class="resource-dropdown-content" id="resourcedropdownContent">
          <a href="#" data-lang="inquiry" onclick="navigateToTopic('Termékérdeklődés')">Érdeklődés termékről</a>
          <a href="#" data-lang="intention" onclick="navigateToTopic('Vásárlási szándék')">Vásárlási szándék</a>
          <a href="#" data-lang="price" onclick="navigateToTopic('Ár és promóció')">Ár és promóció</a>
          <a href="#" data-lang="complaint" onclick="navigateToTopic('Panaszok és problémák')">Panaszok és problémák</a>
          <a href="#" data-lang="service" onclick="navigateToTopic('Szolgáltatás')">Szolgáltatás</a>
          <a href="#" data-lang="other" onclick="navigateToTopic('Egyéb')">Egyéb</a>
          <a href="#" data-lang="all" onclick="navigateToTopic('Összes')">Összes</a>
        </div>
      </div>
      <a href="#statistics" class="buttonsubscription" data-lang="statistics" id="statsLink" style="color:white; font-size:clamp(12px, 1.5vw, 18px);" data-lang="statistics">Metrikák</a>
    </div>

    <!-- Headers on the right -->
    <div style="flex: 0 0 auto; text-align: right;" class="date-container-wide">
      <h1 data-lang="header1" style="color:white; font-size:clamp(12px, 1.7vw, 20px); margin:0;">Chat Messages</h1>
      <p data-lang="header2" style="color:white; font-size:clamp(9px, 1vw, 16px); margin:0; margin-top:0.3em;">/ {{start_date}} to {{end_date}} /</p>
    </div>

    <div style="flex: 0 0 auto; text-align: right; display:none;" class="date-container-narrow">
      <h1 data-lang="header1" style="color:white; font-size:clamp(12px, 1.7vw, 20px); margin:0;">Chat Messages</h1>
      <p data-lang="header3" style="color:white; font-size:clamp(9px, 1vw, 16px); margin:0; margin-top:0.3em;">/ {{start_date}} /</p>
      <p data-lang="header4" style="color:white; font-size:clamp(9px, 1vw, 16px); margin:0; margin-top:0.3em;">/ {{end_date}} /</p>
    </div>

  </div> 
  
  <div class="table-container">
    <div class="table-wrapper"></div>
      <table id="myTable">
        <thead>
            <tr>
              {% for column in columns %}
                {% if loop.index in [1, 2, 4, 5, 6] %}
                  <th style="width: 130px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" data-lang="{{ column }}">{{ column }}</th>
                {% elif loop.index == 3 %}
                  <th style="width: auto;" data-lang="{{ column }}">{{ column }}</th>
                {% else %}
                  <th data-lang="{{ column }}">{{ column }}</th>
                {% endif %}
              {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in rows %}
                <tr>
                    {% for cell in row %}
                        <td>{{ cell | safe }}</td>
                    {% endfor %}
                </tr>
            {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  
  <script>
    const topicCounts = {{ topic_counts | tojson }};
    const topicKeyMap = {
      "Termékérdeklődés": "inquiry",
      "Vásárlási szándék": "intention",
      "Ár és promóció": "price",
      "Panaszok és problémák": "complaint",
      "Szolgáltatás": "service",
      "Egyéb": "other",
      "Összes": "all"
    };


    const topicFromServer = "{{ topic }}";


    function updateTopicHeader(language) {
      const topicTranslations = {
        hu: {
          all: "Összes üzenet",
          inquiry: "Chat termékekről",
          intention: "Vásárlási szándék",
          price: "Chat árakról és promóciókról",
          complaint: "Panaszok és problémák",
          service: "Beszélgetés szolgáltatásokról",
          other: "Egyéb üzenetek"
        },
        en: {
          all: "All messages",
          inquiry: "Product inquiries",
          intention: "Intention to purchase",
          price: "Chats about price and promotion",
          complaint: "Complaints and issues",
          service: "Service-related chats",
          other: "Other messages"
        }
      };

      const topicKey = topicKeyMap[topicFromServer];
      if (!topicKey) return; // if no topic, skip

      const header1Elements = document.querySelectorAll(
        ".date-container-wide h1, .date-container-narrow h1"
      );
      const headerText = topicTranslations[language][topicKey];
      if (!headerText) return;

      header1Elements.forEach(el => {
        el.textContent = headerText;
      });
    }


    function navigateToTopic(topic) {
        const params = new URLSearchParams(window.location.search);

        // Parse the backend-provided dates into JS Date objects
        const startDate = new Date("{{ start_date.isoformat() }}");
        const endDate = new Date("{{ end_date.isoformat() }}");

        if (topic === "Összes") {
            const baseUrl = `/chats_in_requested_period`;

            // Extract components dynamically from start and end
            params.set("year", startDate.getFullYear());
            params.set("month", String(startDate.getMonth() + 1).padStart(2, "0"));
            params.set("day", String(startDate.getDate()).padStart(2, "0"));
            params.set("hour", String(startDate.getHours()).padStart(2, "0"));
            params.set("minutes", String(startDate.getMinutes()).padStart(2, "0"));
            params.set("seconds", String(startDate.getSeconds()).padStart(2, "0"));

            params.set("year_end", endDate.getFullYear());
            params.set("month_end", String(endDate.getMonth() + 1).padStart(2, "0"));
            params.set("day_end", String(endDate.getDate()).padStart(2, "0"));
            params.set("hour_end", String(endDate.getHours()).padStart(2, "0"));
            params.set("minutes_end", String(endDate.getMinutes()).padStart(2, "0"));
            params.set("seconds_end", String(endDate.getSeconds()).padStart(2, "0"));

            params.set("language", "{{ language }}");
            params.set("frequency", "{{ frequency }}");

            window.location.href = `${baseUrl}?${params.toString()}`;
            return;
        }

        const baseUrl = `/chats_in_requested_period/topic`;

        params.set("topic", topic);
        params.set("start_date", "{{ start_date.isoformat() }}");
        params.set("end_date", "{{ end_date.isoformat() }}");
        params.set("language", "{{ language }}");
        params.set("frequency", "{{ frequency }}");

        window.location.href = `${baseUrl}?${params.toString()}`;
    }

    function updateDropdownCounts(topicCounts, language) {
        // Find all dropdown links
        const dropdownLinks = document.querySelectorAll('.resource-dropdown-content a');
        
        // Reset them first (remove any previous counts)
        dropdownLinks.forEach(link => {
          const key = link.dataset.lang;
          link.textContent = translations[language][key];
        });

        // Loop over each topic count and append "(X chat)" or "(X chats)"
        topicCounts.forEach(item => {
          const key = topicKeyMap[item.topic_classification];
          if (!key) return; // skip unknowns
          const link = document.querySelector(`.resource-dropdown-content a[data-lang="${key}"]`);
          if (link) {
            const countText = language === 'hu'
              ? ` (${item.count} chat)`
              : ` (${item.count} chats)`;
            link.textContent += countText;
          }
        });
      }

    const dropdownWrapper = document.querySelector('.dropdown');
    var buttonSubscription = document.getElementById('buttonSubscription');
    var resourcedropdownContent = document.getElementById('resourcedropdownContent');

    function showDropdown(dropdown, button) {
      dropdown.style.display = 'block';
      button.classList.add('active');
  }

  function hideDropdown(dropdown, button) {
      dropdown.style.display = 'none';
      button.classList.remove('active');
  }

    if (dropdownWrapper) {
      dropdownWrapper.addEventListener('mouseenter', function() {
        showDropdown(resourcedropdownContent, buttonSubscription);
      });

      dropdownWrapper.addEventListener('mouseleave', function() {
        setTimeout(function() {
          if (
            !resourcedropdownContent.matches(':hover') &&
            !dropdownWrapper.matches(':hover')
          ) {
            hideDropdown(resourcedropdownContent, buttonSubscription);
          }
        }, 100);
      });
    }

    // --- Metrics link click handler ---
    const statsLink = document.getElementById('statsLink');
    if (statsLink) {
      statsLink.addEventListener('click', function(event) {
        event.preventDefault();

        // Parse the backend-provided dates into JS Date objects
        const startDate = new Date("{{ start_date.isoformat() }}");
        const endDate = new Date("{{ end_date.isoformat() }}");

        const params = new URLSearchParams();

        // Start date parts
        params.set("year", startDate.getFullYear());
        params.set("month", String(startDate.getMonth() + 1).padStart(2, "0"));
        params.set("day", String(startDate.getDate()).padStart(2, "0"));
        params.set("hour", String(startDate.getHours()).padStart(2, "0"));
        params.set("minutes", String(startDate.getMinutes()).padStart(2, "0"));
        params.set("seconds", String(startDate.getSeconds()).padStart(2, "0"));

        // End date parts
        params.set("year_end", endDate.getFullYear());
        params.set("month_end", String(endDate.getMonth() + 1).padStart(2, "0"));
        params.set("day_end", String(endDate.getDate()).padStart(2, "0"));
        params.set("hour_end", String(endDate.getHours()).padStart(2, "0"));
        params.set("minutes_end", String(endDate.getMinutes()).padStart(2, "0"));
        params.set("seconds_end", String(endDate.getSeconds()).padStart(2, "0"));

        // Other parameters from backend
        params.set("language", "{{ language }}");
        params.set("frequency", "{{ frequency }}");
        params.set("topic", topic);

        // Build the target URL and open it in a new tab
        const url = `/productbreakdown_topics?${params.toString()}`;
        window.open(url, '_blank');
      });
    }


      

    // Get the table element
    const table = document.getElementById('myTable');
    const rows = Array.from(table.getElementsByTagName('tr')).slice(1); // Get all rows except the header
  
    // Function to group rows by date
    function groupByDate(rows) {
        const groups = {};
        rows.forEach(row => {
            const createdAt = row.getElementsByTagName('td')[0].textContent.trim();
            const dateOnly = createdAt.split(' ')[0]; // Extract only the date
            if (!groups[dateOnly]) {
                groups[dateOnly] = [];
            }
            groups[dateOnly].push(row);
        });
        return groups;
    }
  
    // Function to sort rows within each date group
    function sortWithinGroup(group) {
        return group.sort((a, b) => {
            const createdAtA = a.getElementsByTagName('td')[0].textContent.trim();
            const createdAtB = b.getElementsByTagName('td')[0].textContent.trim();
            const userIdA = a.getElementsByTagName('td')[1].textContent.trim();
            const userIdB = b.getElementsByTagName('td')[1].textContent.trim();
            
            // Sort by created_at, then by user_id
            if (createdAtA < createdAtB) return -1;
            if (createdAtA > createdAtB) return 1;
            if (userIdA < userIdB) return -1;
            if (userIdA > userIdB) return 1;
            return 0;
        });
    }
  
    // Function to reorder rows by user_id within each date group
    function reorderByUserId(sortedRows) {
        const userGroups = {};
        sortedRows.forEach(row => {
            const userId = row.getElementsByTagName('td')[1].textContent.trim();
            if (!userGroups[userId]) {
                userGroups[userId] = [];
            }
            userGroups[userId].push(row);
        });
  
        const reorderedRows = [];
        Object.keys(userGroups).sort((a, b) => {
            // Compare by the earliest created_at within each user group
            const firstRowA = userGroups[a][0];
            const firstRowB = userGroups[b][0];
            const createdAtA = firstRowA.getElementsByTagName('td')[0].textContent.trim();
            const createdAtB = firstRowB.getElementsByTagName('td')[0].textContent.trim();
            return createdAtA.localeCompare(createdAtB);
        }).forEach(userId => {
            reorderedRows.push(...userGroups[userId]);
        });
  
        return reorderedRows;
    }
  
    // Main processing
    const groupedRows = groupByDate(rows);
    let finalRows = [];
  
    Object.keys(groupedRows).sort().forEach(date => {
        const sortedRows = sortWithinGroup(groupedRows[date]);
        const reorderedRows = reorderByUserId(sortedRows);
        finalRows.push(...reorderedRows);
    });
  
    // Clear the current table body
    const tbody = table.getElementsByTagName('tbody')[0];
    tbody.innerHTML = '';
  
    // Append the final sorted and reordered rows
    finalRows.forEach(row => {
        tbody.appendChild(row);
    });
  
    // Now, apply background colors
    let previousUserId = null;
    let previousDate = null;
    let isEven = false;
  
    finalRows.forEach(row => {
        const cells = row.getElementsByTagName('td');
        const createdAt = cells[0].textContent.trim();
        const userId = cells[1].textContent.trim();
        const dateOnly = createdAt.split(' ')[0];
  
        if (userId !== previousUserId || dateOnly !== previousDate) {
            isEven = !isEven;
            previousUserId = userId;
            previousDate = dateOnly;
        }
  
        if (isEven) {
            row.classList.add('bg-color-even');
        } else {
            row.classList.add('bg-color-odd');
        }
    });

    const translations = {
          en: {
              created_at: "Arrival date",
              chattopic: "Chat Topics",
              inquiry: "Interest in the product",
              intention: "Intention to purchase",
              price: "Price and promotion",
              complaint: "Complaints and issues",
              service: "Service",
              other: "Other",
              all: "All",
              user_id: "User ID",
              message: "Message",
              latitude: "Latitude",
              longitude: "Longitude",
              location: "Location",
              header1:"Chat Messages",
              header2:"/ {{start_date}} to {{end_date}} /",
              header3:"/ {{start_date}} to  ",
              header4:"/ {{end_date}} /",
              user_label: "USER",
              assistant_label: "ASSISTANT",
              statistics: metrics
          },
          hu: {
              created_at: "Beérkezés",
              chattopic: "Chat Témakörök",
              inquiry: "Érdeklődés termékről",
              intention: "Vásárlási szándék",
              price: "Ár és promóció",
              complaint: "Panaszok és problémák",
              service: "Szolgáltatás",
              other:"Egyéb",
              all:"Összes",
              user_id: "Azonosító",
              message: "Üzenet",
              latitude: "Szélesség",
              longitude: "Hosszúság",
              location: "Hely",
              header1:"Üzenetek",
              header2:"/ {{start_date}} - {{end_date}} /",
              header3:"/ {{start_date}} -  ",
              header4:"/ {{end_date}} /",
              user_label: "ÜGYFÉL",
              assistant_label: "ASSZISZTENS",
              statistics: metrikák
          }
          };

            // Set language on page load
    
  
    // Set language on page load
    window.onload = function() {
        if (typeof translations !== 'undefined') {
            // Use backend-provided language if available, otherwise use localStorage, otherwise default to 'hu'
            const backendLang = "{{ language }}"; // Jinja variable
            const storedLang = localStorage.getItem('language');
            const language = backendLang && backendLang !== "" ? backendLang : (storedLang || 'hu');

            setLanguage(language);
            updateTopicHeader(language);
        }
    };

    function setLanguage(language) {
      console.log("Setting language:", language);
      document.querySelectorAll('[data-lang]').forEach(element => {
        const langKey = element.getAttribute('data-lang');
        const translation = translations[language][langKey];

        if (translation) {
          if (element.hasAttribute('placeholder')) {
            // For inputs like <input placeholder="...">
            element.setAttribute('placeholder', translation);
          }else if(element.tagName === "INPUT" && element.type === "submit") {
          // For submit buttons
          element.value = translation;
            
          } else {
            // For regular elements like <div>, <span>, etc.
            element.innerHTML = translation;
          }
        }
      });
      // Update dynamic labels inside messages
      document.querySelectorAll('[data-role="user"]').forEach(el => {
          el.textContent = translations[language].user_label;
      });

      document.querySelectorAll('[data-role="assistant"]').forEach(el => {
          el.textContent = translations[language].assistant_label;
      });
      if (typeof topicCounts !== 'undefined') {
        updateDropdownCounts(topicCounts, language);
      }
    }

      function toggleDateContainers() {
  const wide = document.querySelector('.date-container-wide');
  const narrow = document.querySelector('.date-container-narrow');
  if (window.innerWidth > 600) {
    wide.style.display = 'block';
    narrow.style.display = 'none';
  } else {
    wide.style.display = 'none';
    narrow.style.display = 'block';
  }
}

// Run on load and resize
window.addEventListener('load', toggleDateContainers);
window.addEventListener('resize', toggleDateContainers);



    </script>
    
    
</body>
</html>
  
  
  
  
  
  
  
  
  
