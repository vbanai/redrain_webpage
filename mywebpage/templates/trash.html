<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChatBot</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,1,0" />
  <link rel="stylesheet" href="/static/popup_settings.css">
  

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined&display=swap" />
  <style>
  /* Base button styling */
  .button_save,
  .button_restore {
    display: inline-flex;               /* Align icon + text */
    align-items: center;
    gap: 6px;                           /* Space between icon and text */
    padding: 8px 14px;                  /* Comfortable click area */
    font-size: 14px;
    font-weight: 500;
    color: #ffffff;                     /* Text color */
    background-color: #7a85c5;          /* Base button color */
    border: none;
    border-radius: 15px;                 /* Rounded corners */
    cursor: pointer;                     /* Pointer on hover */
    transition: background-color 0.2s, transform 0.1s;
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
  }

  /* Restore button different color */
  .button_restore {
    background-color: #519653;          /* Green for restore */
  }

  /* Hover effect */
  .button_save:hover {
    background-color: #3455ae;          /* Slightly darker */
    transform: translateY(-1px);        /* Lift effect */
  }


  .button_restore:hover {
    background-color: #19831e;          /* Slightly darker */
    transform: translateY(-1px);        /* Lift effect */
  }


  /* Active effect */
  .button_save:active,
  .button_restore:active {
    transform: translateY(1px);         /* Pressed down */
  }

  /* SVG icons inside buttons */
  .button_save svg,
  .button_restore svg {
    width: 18px;
    height: 18px;
    fill: #ffffff;                  /* Matches text color */
  }
</style>



</head>
<body>

  <section class="home" id="home">
    
  
    <div class="header0">
      <div class="left-section">
        <img src="static/RedRainLogo8.png" alt="" class="hamburger">
      </div>
      <div class="middle-section">
        <ul>
          <li class="nav_item">
            <a href="/servieselector" class="nav_link buttonsubscription" style="font-size: clamp(0.8rem, 1.2vw, 1.03rem);" id="home" data-lang="dashboard">Dashboard</a>
            <div id="navItem">
              <button class="button_save" id="save-config" data-lang="save">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M17 3H7c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 
                          3 1.34 3 3-1.34 3-3 3zm3-10H7V5h8v4z"/>
                </svg>
                Save current state
              </button>

              <button class="button_restore" id="restore-config" data-lang="restore">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M13 3a9 9 0 0 0-9 9H1l4 4 4-4H5a7 7 0 1 1 7 7v-2l4 4-4 4v-2a9 9 0 0 0 0-18z"/>
                </svg>
                Restore previous state
              </button>
            </div>
          </li>
          
        </ul>
      </div>
      <div class="right-section">
        <div class="language-switcher">
          <div class="language-switcher">
            <a href="#" id="lang-en" class="language-link">
              <img src="static/en-flag.png" alt="EN" />
            </a><a href="#" id="lang-hu" class="language-link">
              <img src="static/hu-flag.png" alt="HU" />
            </a>
          </div>
        </div>

        <div class="circle-container">
          <div class="circle" id="circleDropdown">
            <div class="content">
              {{first_character}} <!-- Your character or content here -->
            </div>
          </div>
          <div class="circle-dropdown-content" id="circleDropdownContent">
            {% if chat_control_access %}
              <a href="#service1" id="circleDashboardLink0" data-lang="chatcontrol">Chat Control</a>
            {% endif %}
            {% if metrics_access and user_role in ['Manager', 'Team Leader'] %}
              <a href="{{ url_for('dashboard_vbanai') }}" data-lang="metrics">ChatBot Metrics & Insights</a>
            {% endif %}
            {% if advanced_ai_access and user_role in ['Manager', 'Team Leader'] %}
              <a href="{{ url_for('predictive_dashboard') }}" data-lang="prediction">Advanced AI Predictive Solutions</a>
            {% endif %}
              <a href="#logout" id="logout" action="{{ url_for('logout') }}" method="post" data-lang="logout">Logout</a>
          </div>
        </div>
        
        <!-- <a href="#home" class="buttonlogout" id="form-open">Logout</a> -->
        
      </div>
    </div>
    <div id="flash-messages"></div>
    <div class="settings-grid">



      
      <div class="settings-box">
        <!---------------------------->
        <!-- Customize Header Text  -->
        <!---------------------------->

        <div class="popup-border-settings">
          <h3 data-lang="headertext">Customize header text</h3>

          <!-- Loop over available languages -->
          {% for lang in languages %}
            <div class="setting-row">
              <label data-lang="currenttext">Current text ({{ lang }}):</label>
              <div
                class="current-text-preview"
                id="current-header-text-{{ lang }}"
                style="
                  font-family: {{ header_font_family or '"Inter", sans-serif' }};
                  font-weight: {{ header_font_weight or 400 }};
                "
              >
                {% if lang == "hu" %}{{ language_hu_logo_text }}{% elif lang == "en" %}{{ language_en_logo_text }}{% endif %}
              </div>
            </div>

            <div class="setting-row">
              <label data-lang="newtext" for="header-text-input-{{ lang }}">
                New text ({{ lang }}):
              </label>
              <input
                type="text"
                id="header-text-input-{{ lang }}"
                placeholder="Enter new header text"
                maxlength="60"
              >
            </div>
          {% endfor %}

          <!-- Font family selector -->
          <div class="setting-row">
            <label data-lang="fontfamily" style="font-size:13px;">
              Font family:
            </label>
            <select id="header-font-family">
              <option value='"Inter", sans-serif' {% if header_font_family == '"Inter", sans-serif' %}selected{% endif %}>Inter</option>
              <option value='Arial, sans-serif' {% if header_font_family == 'Arial, sans-serif' %}selected{% endif %}>Arial</option>
              <option value='"Segoe UI", sans-serif' {% if header_font_family == '"Segoe UI", sans-serif' %}selected{% endif %}>Segoe UI</option>
              <option value='"Roboto", sans-serif' {% if header_font_family == '"Roboto", sans-serif' %}selected{% endif %}>Roboto</option>
            </select>
          </div>

          <!-- Font weight -->
          <div class="setting-row">
            <label style="font-size:13px;" data-lang="fontweight">Font weight:</label>
            <input
              type="range"
              id="header-font-weight"
              min="100"
              max="900"
              step="100"
              value="{{ header_font_weight or 400 }}"
            >
            <span id="header-font-weight-value">{{ header_font_weight or 400 }}</span>
          </div>

          <button data-lang="apply" id="apply-header-text">Apply</button>
        </div>


      </div>

      <div class="settings-box">
      

        <!---------------------------->
        <!-- Customize Chat Header  -->
        <!---------------------------->


        <div class="color-settings" data-css-var="--primary-color" data-backend-value="{{ primary_color }}">
          <h3 data-lang="header_avatar_thinking_bgcol">Customize chat header + avatar, thinking indicator & user message background color </h3>

          <!-- Mode toggle -->
          <div class="setting-row">
            <label>
              <input type="radio" name="color-mode" value="solid" checked> 
              <span data-lang="solid">Solid</span>
            </label>
            <label>
              <input type="radio" name="color-mode" value="gradient">
              <span data-lang="gradient">Gradient</span>
            </label>
          </div>

          <!-- Solid color picker -->
          <div id="solid-picker" class="setting-row">
            <label  data-lang="pickacolor" for="solid-color">Please pick a color:</label>
            <input type="color" id="solid-color" value="" class="chat-header-rectangular">
          </div>

          <!-- Gradient color pickers -->
          <div id="gradient-picker" class="setting-row" style="display:none;">
            <label data-lang="start" for="gradient-start">Start color:</label>
            <input type="color" id="gradient-start" value="">
            <label data-lang="end" for="gradient-end">End color:</label>
            <input type="color" id="gradient-end" value="">
          </div>

          <button data-lang="apply" id="apply-colors">Apply</button>
        </div>

      </div>

        <!--------------------------------->
        <!-- Customize Reply Background  -->
        <!--------------------------------->

   
        <!----------------------------------------------------------------->
        <!-- Customize operator, emoji & attachment icons color          -->
        <!----------------------------------------------------------------->

   
        <!------------------------------------------------------------------>
        <!-- Customize Popup Background                                   -->
        <!------------------------------------------------------------------>
      
        <!------------------------------------------------------------------>
        <!-- Customize Footer Background                                  -->
        <!------------------------------------------------------------------>




       
        <!------------------------------------------------------------------>
        <!--   Customize Footer Controls background                       -->
        <!------------------------------------------------------------------>
     
        <!------------------------------------------------------------------>
        <!--   Customize Footer Input Text Background                     -->
        <!------------------------------------------------------------------>

     
        <!------------------------------------------------------------------>
        <!--   Customize Footer focus outline color                     -->
        <!------------------------------------------------------------------>

      
    </div>
    

    


    

  













    <button id="chatbot-toggler">
      <span class="material-symbols-rounded">mode_comment</span>
      <span class="material-symbols-rounded">close</span>
    </button>
    <div class="chatbot-popup">
      <!-- Chatbot Header -->
      <div class="chat-header">
        <div class="header-info">
          <div class="chatbot-logo {% if not use_google_icon and icon_path %}image-logo{% else %}icon-logo{% endif %}">
            {% if not use_google_icon and icon_path %}
              <!-- Show client PNG logo -->
              <img src="{{ icon_path }}" alt="Client Logo" />
            {% else %}
              
              <!-- Fallback: Show Google Material Icon -->
              
              <span class="material-symbols-outlined google-chat-icon">chat</span>
            {% endif %}
                  
          </div>
          <h2 data-lang="Ai_livesupport" class="logo-text">Automata és élő ügyintézés</h2>
        </div>
        <button id="close-chatbot" class="material-symbols-rounded"> keyboard_arrow_down </button>
      </div>

      <!-- Chatbot Body -->
      <div class="chat-body">
      
        <div id="language-selector" class="message bot-message">
          <div class="bot-avatar" style="color: white">
            <span class="material-symbols-outlined graph-icon">graph_6</span>
          </div>
          <div class="message-text">
            <p>Please select your language / Kérlek válassz nyelvet:</p>
            <div class="lang-buttons">
               <button id="select-hu" class="lang-btn">
              <img src="/static/flags/hu-flag.png" alt="HU" class="flag-icon">
                Magyar
              </button>

              <button id="select-en" class="lang-btn">
                <img src="/static/flags/en-flag.png" alt="GB" class="flag-icon">
                English
              </button>
            </div>
          </div>
        </div>
       

        <div id="first-bot-message" class="message bot-message" style="display: none;">
          <div class="bot-avatar" style="color: white">
            <span class="material-symbols-outlined graph-icon">graph_6</span>
          </div>
          <div class="message-text"></div>
        </div>
        
      </div>
      <!-- Chat Footer -->
      <div class="chat-footer">
        <form action="#" class="chat-form">
          <textarea data-lang="sendPlaceholder" data-lang-attr="placeholder" class="message-input" required></textarea>
          <div class="paste-preview"></div> <!-- new preview container -->
          <div class="chat-controls">
            <div class="tooltip">
              <button type="button" id="ask-human" class="material-symbols-rounded">support_agent</button>   <!-- support_agent = icon name as we https://fonts.googleapis.com/css2?-->
              <span data-lang="agent" class="tooltiptext">Ügyintéző</span>
            </div>
            <div class="tooltip">
              <button type="button" id="emoji-picker" class="material-symbols-outlined">sentiment_satisfied</button>
              <span data-lang="emoji" class="tooltiptext">Emoji</span>
            </div>
            
            <div class="file-upload-wrapper tooltip">
              <input type="file" accept="images/*" id="file-input" hidden>
              <img src="#">
              <button type="button" id="file-upload" class="material-symbols-rounded">attach_file</button>
              <div class="disabled-overlay"></div>
              <button type="button" id="file-cancel" class="material-symbols-rounded">close</button>
              <span data-lang="attachment" class="tooltiptext">Melléklet <br> csak elő chat <br>esetén <br>elérhető</span>
            </div>
            

            <button type="submit" id="send-message" class="material-symbols-rounded">arrow_upward</button>

          </div>
        </form>
        <!-- Confirmation popup -->
        <div id="human-confirm" class="human-confirm">
          <button id="close-confirm">×</button>
          <p data-lang="humanConfirmText" id="human-confirm-text" class="agentrequestfont">
            <!-- will be set dynamically -->
          </p>
          <div class="confirm-buttons">
            <button id="confirm-yes" class="check-btn">
              <span class="check-box">
                <svg width="17" height="17" viewBox="0 0 24 24" fill="white">
                  <path d="M20.285 6.708l-11.31 11.31-5.657-5.657 1.414-1.414 4.243 4.243 9.896-9.896z"/>
                </svg>
              </span>
              <span data-lang="confirmYes" class="confirm-label"></span>
            </button>
            
          </div>
        </div>

      </div>
    </div>
  </section>
  <!-- emoji -->
  <script src="https://cdn.jsdelivr.net/npm/emoji-mart@latest/dist/browser.js"></script>
  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- emoji -->
<script src="https://cdn.jsdelivr.net/npm/emoji-mart@latest/dist/browser.js"></script>
<script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
  /*********************************************************
   * 1) Server → Client config (SAFE)
   *********************************************************/
  const APP_CONFIG = {
    supportedLanguages: {{ languages | tojson }},
    texts: {
      logo: {
        hu: {{ language_hu_logo_text | tojson }},
        en: {{ language_en_logo_text | tojson }}
      },
      greeting: {
        hu: {{ greeting_message_hu | tojson }},
        en: {{ greeting_message_en | tojson }}
      }
    },
    icons: {
      agent: {{ agent_icon | tojson }},
      emoji: {{ emoji_icon | tojson }},
      attachment: {{ attachement_icon | tojson }}
    },
    user: {
      id: {{ user_id | tojson }},
      language: {{ language | tojson }},

    },
    client: {
      mode: {{ client_mode | tojson }},
      code: {{ client_id_initial | tojson }}
    },
    styles: {
      primaryColor: {{ primary_color | tojson }},
      borderRadius: {{ border_radius | tojson }},
      borderWidth: {{ border_width | tojson }},
      fontColor: {{ font_color | tojson }},
      operatorIcon: {{ operator_icon | tojson }},
      whiteColor: {{ everything_which_is_white | tojson }},
      userInputMessageColor: {{ user_input_message_color | tojson }},
      popupBgColor: {{ popup_bg_color | tojson }},
      footerBgColor: {{ footer_bg_color | tojson }},
      footerControlsBg: {{ footer_controls_bg | tojson }},
      footerInputBgColor: {{ footer_input_bg_color | tojson }},
      footerFocusOutlineColor: {{ footer_focus_outline_color | tojson }},
      scrollbarColor: {{ scrollbar_color | tojson }},
      confirmationButtonBg: {{ confirmation_button_bgcolor | tojson }},
      replyBgColor: {{ reply_bg_color | tojson }},
      fontGeneral: {{ font_general | tojson }},
      fontHeaderText: {{ font_header_text | tojson }}
    }
  };

  /*********************************************************
   * 2) Language handling
   *********************************************************/
  const supportsMultipleLanguages = APP_CONFIG.supportedLanguages.length > 1;

  if (APP_CONFIG.user.language) {
    localStorage.setItem('language', APP_CONFIG.user.language);
  }

  /*********************************************************
   * 3) Apply CSS variables safely
   *********************************************************/
  const root = document.documentElement;

  const cssVars = {
    '--primary-color': APP_CONFIG.styles.primaryColor,
    '--border-radius': APP_CONFIG.styles.borderRadius,
    '--border-width': APP_CONFIG.styles.borderWidth,
    '--font-color': APP_CONFIG.styles.fontColor,
    '--operator-icon': APP_CONFIG.styles.operatorIcon,
    '--everything-which-is-white': APP_CONFIG.styles.whiteColor,
    '--user-input-message-color': APP_CONFIG.styles.userInputMessageColor,
    '--popup-bg-color': APP_CONFIG.styles.popupBgColor,
    '--footer-bg-color': APP_CONFIG.styles.footerBgColor,
    '--footer-controls-bg': APP_CONFIG.styles.footerControlsBg,
    '--footer-input-bg-color': APP_CONFIG.styles.footerInputBgColor,
    '--footer-focus-outline-color': APP_CONFIG.styles.footerFocusOutlineColor,
    '--footer-form-outline': APP_CONFIG.styles.footerFormOutline,
    '--scrollbar-color': APP_CONFIG.styles.scrollbarColor,
    '--confirmation_button_bgcolor': APP_CONFIG.styles.confirmationButtonBg,
    '--reply-bg-color': APP_CONFIG.styles.replyBgColor,
    '--font-general': APP_CONFIG.styles.fontGeneral,
    '--font-header-text': APP_CONFIG.styles.fontHeaderText
  };

  for (const [key, value] of Object.entries(cssVars)) {
    if (value !== null && value !== undefined) {
      root.style.setProperty(key, value);
    }
  }

  /*********************************************************
   * 4) Extract first color from primary gradient
   *********************************************************/
  if (APP_CONFIG.styles.primaryColor) {
    const firstColorMatch =
      APP_CONFIG.styles.primaryColor.match(/#([0-9a-fA-F]{3,6})/);

    if (firstColorMatch) {
      root.style.setProperty(
        '--primary-color-first-color',
        firstColorMatch[0]
      );
    }
  }
  /*********************************************************
   * 5) Legacy globals (temporary compatibility)
   *********************************************************/
  window.userId = APP_CONFIG.user.id;
  
  window.client_initial_mode = APP_CONFIG.client.mode;
  window.client_code = APP_CONFIG.client.code;

  const huHeaderText = {{ language_hu_logo_text | tojson }};
  const enHeaderText = {{ language_en_logo_text | tojson }};
</script>

  <script>
  

    document.addEventListener("DOMContentLoaded", () => {
      const header = document.querySelector('.header0');

      if (!header) return; // safety check

      function handleScroll() {
        if (window.scrollY > 0) {
          header.style.backgroundColor = 'rgba(0, 0, 0, 1)';
        } else {
          header.style.backgroundColor = 'rgba(0, 0, 0, 0.3)';
        }
      }

      window.addEventListener('scroll', handleScroll);

      // run once in case page is already scrolled on load
      handleScroll();
    });


    const translations = {
    hu: {
      
      dashboard: "Kezelőfelület",
      save: "Beállítások mentése",
      restore: "Korábbi állapot visszaállítása",
      popupborder:"A chatablak keretének szerkesztése",
      color: "Szín:",
      radius: "Rádiusz:",
      width: "Vastagság:",
      apply: "Alkalmaz",
      header_avatar_thinking_bgcol:"Fejléc, ikonok, gondolkozó pontok és felhasználói üzenet buborék háttérszínének beállítása",
      solid:"Egy szín",
      gradient: "Átmenetes kevert szín", 
      pickacolor: "Válassz színt:",
      humanSupport: "Ügyintéző",
      emoji: "Emoji",
      attachment: "Melléklet <br> csak elő chat <br>esetén <br>elérhető",
      humanConfirmText: "Szeretne ügyintézővel beszélni?",
      confirmYes: "Igen",
      sendPlaceholder: "Üzenet...",
      waitResponse: "Kérem, várjon...",
      start: "Kezdő szín:",
      end: "Záró szín:",
      footer_icon_colors:"Operátor, emoji és csatolmány iconok színeinek megváltoztatása",
      bot_agent_message_bc:"Operátor/AI válasz buborék háttérszínénk megváltoztatása",
      popup_body:"A popup üzenetmező háttérszínének beállítása",
      footer_bc:"Az alsó inputblokk háttérszínének beállítása",
      input_text_bc:"Az alsó inputblokkhoz tartozó szövegmező hátterszínének beállítása",
      focusline:"Az input mezőhöz tartozó fókuszkeret színének beállítása",
      Separately_bot_agent_user_message:"Az operátor/AI icon és a felhasználói üzenet háttérszínének beállítása függetlenül a fejléctől",
      bc_agent_emoji_attachement: "Az alsó blokkban lévő operátor, emoji és csatolás iconok háttérszíneinek beállítása",
      bot_agent_font_color:"Az operátor/AI választ megjelenítő betűk színének beállítása",
      smallparts:"Színbeállítás: operator/AI icon, felhasználó üzenetét megjelenítő betűk a középső chatfelületen, fejléc betűk, küldés nyíl, popup bezáró ikon (fent, lent)",
      input_text_color:"Az üzenet betűszínének beállítása az alsó blokkban",
      without_focus:"Az input mezőhöz tartozó keret színének beállítása (nem fókuszálási keret)",
      scrollbar:"Scrollcsúszka színének beállítása",
      bc_confirmation_langugeselector:"Az agent kérő megerősítő és a nyelvi választó gomb háttérszínének beállítása",
      headercolorseparate:"Fejléc szín",
      Ai_livesupport: huHeaderText,
      agent:"Ügyintéző",
      emoji: "Emoji",
      attachment: "Melléklet <br> csak elő chat <br>esetén <br>elérhető",
  
    },
    en: {
      Ai_livesupport: enHeaderText,
      dashboard:"Dashboard",
      save: "Save current state",
      restore: "Restore previous state", 
      popupborder:"Customize popup border",
      color:"Color:",
      radius: "Radius:",
      width:"Width:",
      apply: "Apply",
      header_avatar_thinking_bgcol:"Customize header, icon, thinking indicator and user message bubble background color",
      solid:"Solid",
      gradient:"Gradient",
      pickacolor:"Please pick a color:",
      sendPlaceholder: "Message...",
      humanSupport: "Human support",
      emoji: "Emoji",
      attachment: "Attachment <br> available in <br> human chat",
      humanConfirmText: "Would you like to talk to a colleague?",
      confirmYes: "Yes",
      waitResponse: "Please wait...",
      start: "Start color:",
      end:"End color:",
      footer_icon_colors:"Customize operator, emoji & attachment icons color",
      bot_agent_message_bc:"Customize bot/agent message background color",
      popup_body:"Customize popup body background color",
      footer_bc:"Customize footer background color",
      input_text_bc:"Customize input text background color in the footer",
      focusline:"Customize the color of the input text focus line",
      Separately_bot_agent_user_message:"Separately from the header customize the background color of the bot/agent avatar and the user message",
      bc_agent_emoji_attachment:"Customize the background color of the agent, emoji and attachement icons in the footer",
      bot_agent_font_color:"Customize bot/agent font color",
      smallparts:"Customize colors for bot/agent icon, user font, header font & close buttons, message sending arrow",
      input_text_color:"Customize input message text color in the footer",
      without_focus:"Customize footer text input outline without focus",
      scrollbar:"Customize the scrollbar color",
      bc_confirmation_langugeselector: "Customize confirmation button & language selector button background color for agent intervention",
      headercolorseparate:"Header color",
      Ai_livesupport:"AI & Live Support",
      agent:"Human Support",
      emoji: "Emoji",
      attachment: "Attachment <br> available in <br> human chat",
    } 
  };


// MANAGE THE THE GRAPHICAL LAYOUT CHANGE


  document.getElementById("save-config").addEventListener("click", () => {
    const language = localStorage.getItem('language') || 'hu';

    const message = language === 'hu'
        ? "Biztosan el akarja menteni a jelenlegi konfigurációt?\n\nEz felülírja az aktív kliens konfigurációját."
        : "Are you sure you want to save the current configuration?\n\nThis will overwrite the active client configuration.";

    const confirmed = confirm(message);
    console.log("User confirmed save:", confirmed);
    if (!confirmed) return;

    saveCurrentConfig();
  });

  function getCssVar(name) {
      return getComputedStyle(document.documentElement)
        .getPropertyValue(name)
        .trim() || null;
    }

  function collectClientConfig() {
    return {
 
    };
  }

  async function saveCurrentConfig() {
    const language = localStorage.getItem('language') || 'hu';


    // Collect the current config from the page
    const payload = collectClientConfig();
    const API_BASE = "https://redrain1230.loophole.site";

    try {
        const response = await fetch(`${API_BASE}/api/client/config/manage_previous_layout`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
        });

        const data = await response.json();
        const flashMessages = document.getElementById("flash-messages");

        if (!flashMessages) {
            console.warn("Flash messages container not found!");
            return;
        }

        // Render flash messages from the backend
        if (data.messages) {
            data.messages.forEach(message => {
                const div = document.createElement("div");
                div.className = `flash ${message.category || "info"}`;

                // Localized text fallback
                div.textContent =
                    message[`text_${language}`] ||
                    message.text_en ||
                    message.text ||
                    "Notification";

                flashMessages.appendChild(div);

                // Start fade-out after 3.5s
                setTimeout(() => {
                    div.classList.add("fade-out");
                }, 3500);

                // Remove from DOM after transition
                div.addEventListener("transitionend", () => div.remove());
            });
        }

    } catch (err) {
        console.error(err);

        // Display error flash if something goes wrong
        const flashMessages = document.getElementById("flash-messages");
        if (flashMessages) {
            const div = document.createElement("div");
            div.className = "flash danger";
            div.textContent = "Error saving configuration";
            flashMessages.appendChild(div);

            setTimeout(() => div.classList.add("fade-out"), 3500);
            div.addEventListener("transitionend", () => div.remove());
        }
    }
}

// MANAGE RESTORATION

document.getElementById("restore-config").addEventListener("click", () => {
  const language = localStorage.getItem("language") || "hu";

  const message =
    language === "hu"
      ? "Biztosan vissza szeretné állítani az előző konfigurációt?\n\nEz törli az aktuális beállításokat."
      : "Are you sure you want to restore the previous configuration?\n\nThis will erase the current settings.";

  const confirmed = confirm(message);
  console.log("User confirmed restore:", confirmed);

  if (!confirmed) return;

  restorePreviousConfig();
});

async function restorePreviousConfig() {
  const language = localStorage.getItem("language") || "hu";
  const API_BASE = "https://redrain1230.loophole.site";

  try {
    const response = await fetch(
      `${API_BASE}/api/client/config/restore_previous_layout`,
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        }
      }
    );

    const data = await response.json();
    const flashMessages = document.getElementById("flash-messages");

    if (!flashMessages) return;

    if (data.messages) {
      data.messages.forEach(message => {
        const div = document.createElement("div");
        div.className = `flash ${message.category || "info"}`;
        div.textContent =
          message[`text_${language}`] ||
          message.text_en ||
          message.text ||
          "Notification";



        flashMessages.appendChild(div);

        setTimeout(() => div.classList.add("fade-out"), 3500);
        div.addEventListener("transitionend", () => div.remove());
      });
    }

    // Optional: reload page to apply restored CSS
    if (data.success) {
      setTimeout(() => window.location.reload(), 3500);
    }

  } catch (err) {
    console.error(err);
  }
}

const langEnBtn = document.getElementById('lang-en');
if (langEnBtn) {
  langEnBtn.addEventListener('click', function() {
    const newLang = 'en';
    localStorage.setItem('language', newLang);
    setLanguage(newLang);

    fetch('/update_language', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ language: newLang }),
      credentials: 'include'
    });
  });
}

const langHuBtn = document.getElementById('lang-hu');
if (langHuBtn) {
  langHuBtn.addEventListener('click', function() {
    const newLang = 'hu';
    localStorage.setItem('language', newLang);
    setLanguage(newLang);

    fetch('/update_language', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ language: newLang }),
      credentials: 'include'
    });
  });
}

// Set language on page load
window.onload = function() {
    if (typeof translations !== 'undefined') {
        // Use backend-provided language if available, otherwise use localStorage, otherwise default to 'hu'
        const backendLang = "{{ language }}"; // Jinja variable
        const storedLang = localStorage.getItem('language');
        const language = backendLang && backendLang !== "" ? backendLang : (storedLang || 'hu');

        setLanguage(language);
    }
};





function setLanguage(language) {
  document.querySelectorAll('[data-lang]').forEach(element => {
    const langKey = element.getAttribute('data-lang');
    const translation = translations[language][langKey];

    if (translation) {
      if (element.hasAttribute('placeholder')) {
        // For inputs like <input placeholder="...">
        element.setAttribute('placeholder', translation);
      } else {
        // For regular elements like <div>, <span>, etc.
        element.innerHTML = translation;
      }
    }
  });
}












  </script>

  <script src="/static/popup_settings.js"></script>
</body>
</html>